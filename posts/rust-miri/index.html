<!doctype html><html lang=ja-jp><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Rust の中間言語インタープリタ MIRI による検証 | kazuk のメモ書き</title><link rel=stylesheet href=/kazuk.log/css/style.css><link rel=stylesheet href=/kazuk.log/css/fonts.css></head><body><nav><ul class=menu><li><a href=/kazuk.log/>Home</a></li><li><a href=/kazuk.log/categories/>Categories</a></li><li><a href=/kazuk.log/tags/>Tags</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Rust の中間言語インタープリタ MIRI による検証</span></h1><h2 class=date>2021/08/20</h2></div><main><h1 id=rust-の中間言語インタープリタ-miri-による検証>Rust の中間言語インタープリタ MIRI による検証</h1><p>Rust の中間言語は <a href=https://github.com/rust-lang/rfcs/blob/master/text/1211-mir.md>MIR</a> と呼ばれます。</p><p>この中間言語コードを実行するインタープリタが <a href=https://github.com/rust-lang/miri>MIRI</a> です。</p><p>インタープリタ実行の為、多少低速ではありますが、コンパイルされたバイナリを実行する時にはできない諸々の検証が行える為、ライブラリの利用方法の誤りや、unsafe コードを含む rust コードに誤りが無いかを確認できます。unsafe コードの動作に問題が無いか確認できるという点で unsafe コードを含むコードを開発している場合には MIRI の利用は強く推奨できます。</p><p>「unsafe コード書いて MIRI 回してないってホント大丈夫？」</p><p>って言うレベルで unsafe コードを書いているなら必須です。</p><p>なので何らか重要なライブラリやフレームワークの導入時にソースを clone してきて回してみるぐらいはした方が良いかなと思います。</p><h2 id=miri-の導入>MIRI の導入</h2><p>MIRI を導入するのは比較的簡単で nightly ツールチェインに対して miri を追加するだけでセットアップできますす。</p><pre><code class=language-shell-session data-lang=shell-session>$ rustup +nightly component add miri
</code></pre><h2 id=miri-の実行>MIRI の実行</h2><p>既存のテストを MIRI で実行するには <code>cargo +nightly miri test</code> で行います。</p><pre><code class=language-shell-session data-lang=shell-session>$ cargo +nightly miri test
</code></pre><h2 id=miri-で検出したエラーへの対処>MIRI で検出したエラーへの対処</h2><p>この部分が MIRI の弱さではありますが、エラーログとライブラリのドキュメントその他を熟読して何故エラーとして報告されるのかを確認するしかありません。</p><p>unsafe となっているライブラリメソッドには概ね Safety についての解説がありますので、呼び出している unsafe メソッドの Safety についての解説を確認しましょう。</p><p>とりあえずエラーを開発者に一報した上でソースとライブラリドキュメントを読み込んで開発者と一緒に問題をクリアしていけると良いですね。</p><h2 id=自分が見つけた-miri-エラー>自分が見つけた MIRI エラー</h2><p>何か見つける毎に追記していこうと思います。</p><ul><li><a href=https://github.com/rg3dengine/rg3d/issues/155>rg3dengine/rg3d#155: MIRI test failed on scene::mesh::buffer::test::test_add_attribute</a></li></ul></main><footer><hr>© <a href=https://github.com/kazuk>kazuk</a> 2017 &ndash; 2020 | <a href=https://twitter.com/kazuk>Twitter</a></footer></body></html>